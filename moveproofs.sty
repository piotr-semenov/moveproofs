% moveproofs: a package for auto-moving proofs to the appendix of a document.
% 
% (c) Daniel Haas, 2016
%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory macros/latex/base/lppl.txt.
% 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{moveproofs}[2016/02/22 LaTex package for auto-moving proofs to the appendix]

\RequirePackage{pgfkeys}
\RequirePackage{pgfopts}
\RequirePackage{ntheorem}
\RequirePackage{cleveref}

% TODO(dhaas): By default, create an appendix and a section in the appendix called "Proofs" if no appendixproofsections are defined. Further, place all of the proofs in the default section.
% TODO(dhaas): Add options for the defaultappendixsectionname.
% TODO(dhaas): Make sure whitespacing in document is consistent with inline or appendix options.

% Namespace our key-value store.
\pgfkeys{/moveproofs/.is family}

% Set up the 'location' option, which may be set to 'inline' (don't move proofs) or 'appendix' (move proofs to the appendix).
\newif\ifmoveproofstoappendix
\pgfkeys{moveproofs,
  location/.is choice,
  location/inline/.code={\moveproofstoappendixfalse},
  location/appendix/.code={\moveproofstoappendixtrue},}

% Process the passed package options
\ProcessPgfOptions{moveproofs}

% Define a simple proof environment if it doesn't exist.
\makeatletter
\def\provideenvironment{\@star@or@long\provide@environment}
\def\provide@environment#1{%
        \@ifundefined{#1}%
                {\def\reserved@a{\newenvironment{#1}}}%
                {\def\reserved@a{\renewenvironment{dummy@environ}}}%
        \reserved@a
}
\def\dummy@environ{}
\makeatother
\provideenvironment{proof}{ \par\noindent{\bfseries\upshape Proof\ }}{}

% Low-level commands for manipulating the kv-store.
\newcommand{\MPStoreProof}[2]{\pgfkeys{moveproofs, proofs/#1/content/.code={#2}}}
\newcommand{\MPGetProof}[1]{\pgfkeys{moveproofs, proofs/#1/content}}
%\newcommand{\MPStoreProofStatementType}[2]{\pgfkeys{moveproofs, proofs/#1/statement type/.code={#2}}}
%\newcommand{\MPGetProofStatementType}[1]{\pgfkeys{moveproofs, proofs/#1/statement type}}

% The \makeproof command lets you define a proof in the document.
% Arguments are a label for the proof, and the proof body itself.
% Example usage: \makeproof[Corollary]{corollary_one}{$a = b$, so we're done.}.
\newcommand{\makeproof}[2]{
    % #1 is the statement label (e.g. theorem_one)
    % #2 is the proof content
    \MPStoreProof{#1}{#2}

    % Insert the proof directly into the document inline if required by package options.
    \ifmoveproofstoappendix
    \else
        \begin{proof}
        \MPGetProof{#1}
        \end{proof}
    \fi
}

% The \appendixproof command lets you mark where a proof will be moved to.
% If location="appendix" was passed, it will create a subsection in the appendix with the proof in it.
% The argument is the theorem label you passed to \makeproof.
% Example usage: \appendixproof{corollary_one}
\newcommand{\appendixproof}[1]{
\ifmoveproofstoappendix
    \subsection{Proof of \Cref{#1}}\label{#1_proof}
    \begin{proof}
    \MPGetProof{#1}
    \end{proof}
\else
\fi
}

% The \appendixproofsection command lets you add a section to contain proofs in the appendix.
% The section will only appear if location="appendix".
\newcommand{\appendixproofsection}[1]{
\ifmoveproofstoappendix
    \section{#1}
\fi
}
